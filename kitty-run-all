#!/usr/bin/env python

import os
import sys
import subprocess
import argparse

def parse_spec(args, parser) -> list[list[str]]:
    if args.commands[0] == "\\":
        parser.error("Invalid command list: leading '-' is not allowed")

    command_rows = [[args.commands[0]]]
    previous_was_pipe = False
    for token in args.commands[1:]:
        if token == "\\":
            if previous_was_pipe:
                parser.error("Invalid command list: consecutive '\\' is not allowed")
            previous_was_pipe = True
            continue

        if previous_was_pipe:
            # Start a new row for horizontal split
            command_rows.append([token])
        else:
            # Add to the current row for vertical split
            command_rows[-1].append(token)

        previous_was_pipe = False

    if previous_was_pipe:
        parser.error("Invalid command list: trailing '\\' is not allowed")
    return command_rows


def wrap_command(close_on_success, command) -> str:
    if close_on_success:
        wrapped = f'{command} && echo (set_color green)"Command successful, closing window in 10 seconds"(set_color normal) && sleep 10 && kitty @ close-window --self'
    else:
        wrapped = command
    return wrapped


def create_windows(close_on_success, commands, current_window) -> list[list[str]]:
    # Initialize the list of windows with the current window
    window_rows = [[current_window]]

    # Split windows until we have enough for all commands
    for row_index, commands_in_row in enumerate(commands):
        # Skip the first row since it's already the current window
        if row_index == 0:
            continue

        wrapped = wrap_command(close_on_success, commands_in_row[0])

        # Split each window and add the new windows to the list
        new_window = subprocess.check_output([
            "kitty", "@", "launch", "--type=window", "--cwd", os.getcwd(),
            "--hold", "--location=hsplit", "--next-to", f"id:{window_rows[row_index-1][0]}", "fish", "-c", f"{wrapped}\n"
        ]).strip().decode('utf-8')

        window_rows.append([new_window])
    return window_rows


def create_horizontal_windows(close_on_success, commands, windows):
    for row_index, commands_in_row in enumerate(commands):
        windows_in_row = windows[row_index]

        for idx, command in enumerate(commands_in_row[1:]):
            wrapped = wrap_command(close_on_success, command)
            if close_on_success:
                wrapped = f'{command} && echo (set_color green)"Command successful, closing window in 10 seconds"(set_color normal) && sleep 10 && kitty @ close-window --self'
            else:
                wrapped = command

            new_window = subprocess.check_output([
                "kitty", "@", "launch", "--type=window", "--cwd", os.getcwd(),
                "--hold", "--location=vsplit", f"--next-to=id:{windows_in_row[idx-1]}", "fish", "-c", f"{wrapped}\n"]
            ).strip().decode('utf-8')
            windows_in_row.append(new_window)


def focus_window(current_window):
    subprocess.run([
        "kitty", "@", "focus-window", f"--match=id:{current_window}"
    ])


def get_current_window() -> str:
    current_window = os.environ.get("KITTY_WINDOW_ID")
    if not current_window:
        print("Error: KITTY_WINDOW_ID environment variable is not set.")
        sys.exit(1)
    return current_window


def main():
    parser = argparse.ArgumentParser(
        prog='kitty-run-all',
        description="Run multiple commands in split Kitty windows.\n"
                    "Use '-' before a command to create a horizontal split instead of the default vertical split.",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        usage="%(prog)s [options] <command1> [| <command2>] <command3> ..."
    )
    parser.add_argument('--close-on-success', action='store_true',
                        help="Close the window after successful command execution (with a 5-second delay)")
    parser.add_argument('commands', nargs='+',
                        help="Commands to run")
    args = parser.parse_args()

    close_on_success = args.close_on_success

    commands = parse_spec(args, parser)

    current_window = get_current_window()

    windows = create_windows(close_on_success, commands, current_window)

    create_horizontal_windows(close_on_success, commands, windows)

    focus_window(current_window)

    # Run the first command in the current window
    subprocess.run(["fish", "-c", wrap_command(False, commands[0][0])])


if __name__ == "__main__":
    main()
