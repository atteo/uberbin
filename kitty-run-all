#!/usr/bin/env python

import os
import sys
import subprocess
import argparse

def main():
    parser = argparse.ArgumentParser(
        prog='kitty-run-all',
        description="Run multiple commands in split Kitty windows.\n"
                    "Use '|' before a command to create a vertical split instead of the default horizontal split.",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        usage="%(prog)s [options] <command1> [| <command2>] <command3> ..."
    )
    parser.add_argument('--close-on-success', action='store_true',
                        help="Close the window after successful command execution (with a 5-second delay)")
    parser.add_argument('commands', nargs='+',
                        help="Commands to run")
    args = parser.parse_args()

    close_on_success = args.close_on_success
    commands = args.commands

    # Get the current Kitty window ID
    current_window = os.environ.get("KITTY_WINDOW_ID")
    if not current_window:
        print("Error: KITTY_WINDOW_ID environment variable is not set.")
        sys.exit(1)

    # Initialize the list of windows with the current window
    window_ids = [current_window]
    new_window_ids = []

    i = 1
    win = 0

    # Split windows until we have enough for all commands
    while i < len(commands):
        # if command is "|" then skip the next command
        if commands[i] == "|":
            i += 2
            continue

        if len(window_ids) <= win:
            # Starting new round of splittings
            window_ids = new_window_ids
            new_window_ids = []
            win = 0

        # Split each window and add the new windows to the list
        new_window = subprocess.check_output([
            "kitty", "@", "launch", "--type=window", "--cwd", os.getcwd(),
            "--location=hsplit", "--next-to", f"id:{window_ids[win]}",
        ]).strip().decode('utf-8')
        new_window_ids.extend([window_ids[win], new_window])
        i += 1
        win += 1

    # Add the remaining windows to the list
    new_window_ids.extend(window_ids[win:len(window_ids)])
    window_ids = new_window_ids

    i = 1
    win = 1
    while i < len(commands):
        if commands[i] == "|":
            i += 1
            if close_on_success:
                wrapped = f'{commands[i]} && echo (set_color green)"Command successful, closing window in 10 seconds"(set_color normal) && sleep 10 && kitty @ close-window --self'
            else:
                wrapped = commands[i]

            new_window = subprocess.check_output([
                "kitty", "@", "launch", "--type=window", "--cwd", os.getcwd(),
                "--hold", "--location=vsplit", f"--next-to=id:{window_ids[win-1]}", "fish", "-c", f"{wrapped}\n"])
            window_ids[win-1] = new_window
        else:
            if close_on_success:
                wrapped = f'{commands[i]} && echo (set_color green)"Command successful, closing window in 10 seconds"(set_color normal) && sleep 10 && kitty @ close-window --self'
            else:
                wrapped = commands[i]

            subprocess.run([
                "kitty", "@", "send-text", "--match", f"id:{window_ids[win]}", f"{wrapped}\n"
            ])
            win += 1

        i += 1

    # focus current_window
    subprocess.run([
        "kitty", "@", "focus-window", f"--match=id:{current_window}"
    ])

    # Run the first command in the current window
    subprocess.run(["fish", "-c", commands[0]])

if __name__ == "__main__":
    main()
